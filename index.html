<!DOCTYPE html>
<html>
<head>
    <title>EmulatorJS - Automatic ROM Loading</title>
    <link rel="icon" href="docs/favicon.ico" sizes="16x16 32x32 48x48 64x64" type="image/vnd.microsoft.icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Include your effects.css file -->
    <link rel="stylesheet" href="effects.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background: url('Zool_start_background.gif') center center / cover no-repeat fixed;
        }
        body {
            font-family: monospace;
            font-weight: bold;
            font-size: 2vh;
        }
        #display {
            width: 100%;
            height: 100%;
        }
        #game {
            width: 100%;
            height: 100%;
        }

        /* Hide the input fields */
        #hidden-inputs {
            display: none;
        }

        /* Center the Play Button image */
        #play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            cursor: pointer;
        }

        /* Adjust the image size if needed */
        #play-button img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Style for the exit modal */
        .exit-modal .modal-dialog {
            max-width: 500px;
        }
        .exit-modal .modal-body {
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Hidden Inputs -->
    <div id="hidden-inputs">
        <input type="text" id="rom-url" value="https://raw.githubusercontent.com/FrankieDaDev/EmulatorJS-Zool/main/Zool%20(U).smc">
        <input type="text" id="bios-url" value="https://raw.githubusercontent.com/FrankieDaDev/EmulatorJS-Zool/main/scph5501.bin">
    </div>

    <!-- Play Button -->
    <div id="play-button">
        <img src="Play_Button.png" alt="Play Now">
    </div>

    <!-- Emulator Container -->
    <div id="display">
        <div id="game"></div>
    </div>

    <!-- Exit Modal -->
    <div class="modal exit-modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Exit Intent Popup</h4>
                </div>
                <div class="modal-body">
                    <p>Exit modal shown <span id="modal-counter">0</span> times. Are you sure you want to leave? Please enter your information:</p>
                    <form id="user-info-form">
                        <div class="form-group">
                            <label for="name">Name:</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="form-group">
                            <label for="solana-wallet">Solana Wallet Address:</label>
                            <input type="text" class="form-control" id="solana-wallet" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary submit-user-info">Submit and Leave</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to determine the emulator core based on the ROM file extension
        const getCoreFromExtension = (ext) => {
            const coreMap = {
                "nes": "nes",
                "unf": "nes",
                "smc": "snes",
                "sfc": "snes",
                "fig": "snes",
                "bin": "psx",
                "img": "psx",
                "iso": "psx",
                "cue": "psx",
                // Add other mappings as needed
            };
            return coreMap[ext.toLowerCase()] || null;
        };

        // Load ROM and BIOS when the Play Button is clicked
        document.getElementById("play-button").addEventListener("click", () => {
            const romUrl = document.getElementById("rom-url").value;
            const biosUrl = document.getElementById("bios-url").value;
            const romFileName = romUrl.split("/").pop();
            const romExtension = romFileName.split(".").pop();
            const core = getCoreFromExtension(romExtension);

            if (!core) {
                alert("Unsupported ROM file type.");
            } else {
                // Hide the Play Button
                document.getElementById("play-button").style.display = 'none';

                // Configure EmulatorJS
                window.EJS_player = "#game";
                window.EJS_core = core;
                window.EJS_gameUrl = romUrl;
                window.EJS_gameName = romFileName.split(".")[0]; // Name without extension
                window.EJS_biosUrl = biosUrl; // BIOS file path
                window.EJS_pathtodata = "data/";  // Adjust if necessary
                window.EJS_startOnLoaded = true;

                // Load the EmulatorJS loader script
                const script = document.createElement("script");
                script.src = "data/loader.js"; // Adjust path if necessary
                document.body.appendChild(script);
            }
        });
    </script>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js" type="text/javascript"></script>
    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" type="text/javascript"></script>
    <!-- Exit plugin -->
    <script type="text/javascript" src="jquery.exit-modal.js"></script>
    <!-- Main script -->
    <script type="text/javascript" src="emulator.js"></script>

    <script type="text/javascript">
        $(document).ready(function(){
            var timer;
            var mouseY = 0;
            var thresholdY = 10; // Adjust this value as needed

            // Initialize the exit modal
            $('.exit-modal').on('show.bs.modal', function (e) {
                var counter = $('.exit-modal').data('showCounter') || 0;
                counter++;
                $('.exit-modal').data('showCounter', counter);
                $('#modal-counter').text(counter);
            });

            $('.exit-modal').on('shown.bs.modal', function (e) {
                timer = setTimeout(function(){
                    // Commented out: window.location.href = "http://www.jqueryscript.net";
                }, 4000);
            });

            $('.exit-modal').on('hide.bs.modal', function (e) {
                clearTimeout(timer);
            });

            // Handle form submission
            $('.submit-user-info').on('click', function () {
                var name = $('#name').val();
                var solanaWallet = $('#solana-wallet').val();

                if (name && solanaWallet) {
                    var userInfo = {
                        name: name,
                        solanaWallet: solanaWallet
                    };

                    // Save user info in JSON format
                    var jsonUserInfo = JSON.stringify(userInfo);
                    console.log('User info saved:', jsonUserInfo);

                    // You can send this JSON to a server or save it locally
                    // For example, to save it locally:
                    localStorage.setItem('userInfo', jsonUserInfo);

                    // Close the modal and allow the user to leave
                    $('.exit-modal').modal('hide');
                    // Commented out: window.location.href = "http://www.jqueryscript.net";
                } else {
                    alert('Please fill out all fields.');
                }
            });

            // Show the modal when the user tries to leave the page
            $(document).on('mousemove', function(e) {
                if (e.clientY < thresholdY && e.clientY < mouseY) {
                    $('.exit-modal').modal('show');
                }
                mouseY = e.clientY;
            });

            // Fallback for mobile devices
            $(window).on('touchstart', function(e) {
                var touch = e.originalEvent.touches[0] || e.originalEvent.changedTouches[0];
                if (touch.clientY < thresholdY) {
                    $('.exit-modal').modal('show');
                }
            });

            // Prevent the default behavior of the beforeunload event
            $(window).on('beforeunload', function(e) {
                e.preventDefault();
                e.returnValue = '';
            });
        });
    </script>
</body>
</html>
